name: Deploy howdy-site (Hosting + Functions)

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      FIREBASE_PROJECT_ID: howdy-site-123
      FIREBASE_WEB_API_KEY: ${{ secrets.FIREBASE_WEB_API_KEY }}
      FIREBASE_WEB_APP_ID: ${{ secrets.FIREBASE_WEB_APP_ID }}
      FIREBASE_WEB_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_WEB_MESSAGING_SENDER_ID }}
      FIREBASE_WEB_STORAGE_BUCKET: ${{ secrets.FIREBASE_WEB_STORAGE_BUCKET }}
      FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
      FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Flutter pub get
        working-directory: .
        run: flutter pub get

      - name: Build Flutter Web
        working-directory: .
        run: |
          flutter build web --release \
            --dart-define=FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID} \
            --dart-define=FIREBASE_WEB_API_KEY=${FIREBASE_WEB_API_KEY} \
            --dart-define=FIREBASE_WEB_APP_ID=${FIREBASE_WEB_APP_ID} \
            --dart-define=FIREBASE_WEB_MESSAGING_SENDER_ID=${FIREBASE_WEB_MESSAGING_SENDER_ID} \
            --dart-define=FIREBASE_WEB_STORAGE_BUCKET=${FIREBASE_WEB_STORAGE_BUCKET}

      - name: Install Firebase CLI
        run: npm i -g firebase-tools
      
      - name: Authenticate to Google Cloud (service account)
        id: auth
        if: ${{ env.FIREBASE_SERVICE_ACCOUNT_JSON != '' }}
        uses: google-github-actions/auth@v2
        continue-on-error: true
        with:
          credentials_json: ${{ env.FIREBASE_SERVICE_ACCOUNT_JSON }}
          project_id: ${{ env.FIREBASE_PROJECT_ID }}
      
      - name: Deploy with Service Account (preferred)
        id: deploy_sa
        if: ${{ env.FIREBASE_SERVICE_ACCOUNT_JSON != '' }}
        working-directory: .
        continue-on-error: true
        run: |
          firebase deploy --only hosting:howdy-site-123,firestore:rules --project ${FIREBASE_PROJECT_ID} --non-interactive
      
      - name: Deploy with Legacy Token (fallback)
        if: ${{ env.FIREBASE_TOKEN != '' && (env.FIREBASE_SERVICE_ACCOUNT_JSON == '' || steps.auth.outcome == 'failure' || steps.deploy_sa.outcome == 'failure') }}
        working-directory: .
        env:
          FIREBASE_TOKEN: ${{ env.FIREBASE_TOKEN }}
        run: |
          unset GOOGLE_APPLICATION_CREDENTIALS CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE GOOGLE_GHA_CREDS_PATH CLOUDSDK_CORE_PROJECT CLOUDSDK_PROJECT GCLOUD_PROJECT GCP_PROJECT GOOGLE_CLOUD_PROJECT || true
          firebase deploy --only hosting:howdy-site-123,firestore:rules --project ${FIREBASE_PROJECT_ID} --non-interactive


